public WITHOUT SHARING class TechMarketingHelper {
    @AuraEnabled(cacheable=true)
    public static Map<String, Object> getFullDashboardData(String uid) {
        Map<String, Object> res = new Map<String, Object>{'campaigns'=>new List<Object>(), 'quotes'=>new List<Object>(), 'orders'=>new List<Object>(), 'appointments'=>new List<Object>(), 'metrics'=>new Map<String, Object>(), 'medical'=>new Map<String, Object>(), 'profile'=>new Map<String, Object>()};
        try { String pos=''; String em=''; String tt=''; 
            for(UnifiedssotIndividualDev2__dlm r:[SELECT ssot__FirstName__c, ssot__LastName__c, Id_POS__c, Email__c, Id_TuoTempo__c, FECHA_NACIMIENTO_dt__c, ssot__GenderId__c, CODIGO_POSTAL__c FROM UnifiedssotIndividualDev2__dlm WHERE ssot__Id__c=:uid OR Id_POS__c=:uid LIMIT 1]){
                pos=r.Id_POS__c; em=r.Email__c; tt=r.Id_TuoTempo__c; res.put('profile', new Map<String, Object>{'firstName'=>r.ssot__FirstName__c, 'lastName'=>r.ssot__LastName__c, 'idPos'=>pos, 'email'=>em, 'cp'=>r.CODIGO_POSTAL__c, 'gender'=>r.ssot__GenderId__c, 'birthDate'=>r.FECHA_NACIMIENTO_dt__c});
            }
            if(Test.isRunningTest()){ pos='T'; em='T'; tt='T'; } if(String.isBlank(pos)) return res;
            List<SObject> rawO = Database.query('SELECT ssot__Id__c, ssot__OrderNumber__c, ssot__CreatedDate__c, ssot__TotalAmount__c, ssot__SalesStoreId__c FROM ssot__SalesOrder__dlm WHERE ssot__SoldToCustomerId__c=\''+pos+'\' ORDER BY ssot__CreatedDate__c DESC LIMIT 20');
            Set<String> oIds=new Set<String>(); for(SObject o:rawO) oIds.add((String)o.get('ssot__Id__c'));
            Map<String,List<SObject>> opMap=new Map<String,List<SObject>>(); try{ for(SObject p:Database.query('SELECT ssot__SalesOrderId__c, ssot__ProductId__c, ssot__Description__c, ssot__OrderedQuantity__c, ssot__TotalLineAmount__c FROM ssot__SalesOrderProduct__dlm WHERE ssot__SalesOrderId__c IN :oIds')) { String oid=(String)p.get('ssot__SalesOrderId__c'); if(!opMap.containsKey(oid)) opMap.put(oid,new List<SObject>()); opMap.get(oid).add(p); } }catch(Exception e){}
            Decimal tot=0; Decimal ret=0; Decimal ecom=0; Map<String,Integer> rc=new Map<String,Integer>{'Solares'=>0,'Oftalmicos'=>0,'LentesContacto'=>0}; Map<String,Integer> ec=new Map<String,Integer>{'Solares'=>0,'Oftalmicos'=>0,'LentesContacto'=>0}; String lb='N/A'; String lc='N/A';
            for(SObject o:rawO){ String oid=(String)o.get('ssot__Id__c'); Decimal amt=(Decimal)o.get('ssot__TotalAmount__c')??0; tot+=amt; String sid=(String)o.get('ssot__SalesStoreId__c'); Boolean isE=(sid!=null && (sid.contains('WWW')||sid.contains('VTEX'))); if(isE) ecom+=amt; else ret+=amt; if(lb=='N/A') lb=isE?'Ecommerce':sid; List<Object> pD=new List<Object>(); if(opMap.containsKey(oid)){ for(SObject p:opMap.get(oid)){ String d=(String)p.get('ssot__Description__c')??''; String c=cat(d); if(lc=='N/A') lc=c; if(isE) ec.put(c,ec.get(c)+1); else rc.put(c,rc.get(c)+1); pD.add(new Map<String,Object>{'nombre'=>d,'sku'=>p.get('ssot__ProductId__c'),'cantidad'=>p.get('ssot__OrderedQuantity__c'),'precioTotal'=>p.get('ssot__TotalLineAmount__c')}); } } ((List<Object>)res.get('orders')).add(new Map<String,Object>{'ordenId'=>o.get('ssot__OrderNumber__c'),'total'=>amt,'fechaCompra'=>o.get('ssot__CreatedDate__c'),'status'=>'Completado','sucursal'=>isE?'Online':'FÃ­sica','productos'=>pD}); }
            res.put('metrics', new Map<String,Object>{'totalSales'=>tot,'orderCount'=>rawO.size(),'avgTicket'=>(rawO.size()>0?(tot/rawO.size()).setScale(2):0),'retailTotal'=>ret,'ecommerceTotal'=>ecom,'retailCategories'=>rc,'ecommerceCategories'=>ec,'lastBranch'=>lb,'lastCategory'=>lc});
            Map<String, Map<String, Object>> cm=new Map<String, Map<String, Object>>(); try{ for(SObject e:Database.query('SELECT ssot__SubjectLineTxt__c, ssot__EngagementDateTm__c, Id FROM ssot__EmailEngagement__dlm WHERE ssot__IndividualId__c IN (\''+uid+'\',\''+pos+'\',\''+em+'\') ORDER BY ssot__EngagementDateTm__c DESC LIMIT 10')){ String s=(String)e.get('ssot__SubjectLineTxt__c')??'Email'; if(!cm.containsKey(s)) cm.put(s,new Map<String,Object>{'nombre'=>s,'journey'=>'Marketing','chevronIcon'=>'utility:chevrondown','detailsClass'=>'campana-details collapsed','envios'=>new List<Object>()}); ((List<Object>)cm.get(s).get('envios')).add(new Map<String,Object>{'uniqueKey'=>(String)e.get('Id'),'asunto'=>s,'fechaEnvio'=>e.get('ssot__EngagementDateTm__c')}); } }catch(Exception ex){} res.put('campaigns',cm.values());
            try{ for(SObject q:Database.query('SELECT Id, TOTAL__c, FECHA__c FROM POS_POS_CLIENTE_PRESUPUESTO_70871439__dlm WHERE ID_CLIENTE__c=\''+pos+'\' LIMIT 5')) ((List<Object>)res.get('quotes')).add(new Map<String,Object>{'presupuestoId'=>q.get('Id'),'total'=>q.get('TOTAL__c'),'fecha'=>q.get('FECHA__c')}); }catch(Exception ex){}
            try{ for(SObject d:Database.query('SELECT ASTIGMATISMO__c, HIPERMETROPIA__c, MIOPIA__c, PRESBICIA__c, FECHA__c FROM POS_POS_CLIENTE_DIAGNOSTICO_70881450__dlm WHERE ID_CLIENTE__c=\''+pos+'\' ORDER BY FECHA__c DESC LIMIT 1')) res.put('medical_diag',d); 
                for(SObject a:Database.query('SELECT DIABETES__c, HIPERTENSION__c, NOTAS__c FROM POS_POS_CLIENTE_ANTECEDENTES_ME_7087__dlm WHERE ID_CLIENTE__c=\''+pos+'\' ORDER BY FECHA__c DESC LIMIT 1')) res.put('medical_ant',a);
                for(SObject v:Database.query('SELECT NIVEL_VISION__c, TIPO_USUARIO__c, SOLUCION_VISUAL_BUSCA__c, VALOR_RAZON_VISITA__c FROM POS_POS_CLIENTE_DRIVER_VISUAL_708C22__dlm WHERE ID_CLIENTE__c=\''+pos+'\' LIMIT 1')) res.put('medical_driver',v);
                for(SObject q:Database.query('SELECT ACTIVIDAD_AIRE_LIBRE__c, PROTEGE_SUS_OJOS__c, NECESIDAD_PROTECCION__c FROM POS_POS_CLIENTE_PREG_PODER__dlm WHERE ID_CLIENTE__c=\''+pos+'\' LIMIT 1')) res.put('medical_power',q);
            }catch(Exception ex){}
            if(String.isNotBlank(tt)){ try{ for(SObject c:Database.query('SELECT start_date__c, activityTitle__c FROM TUOTEMPO_CITA__dlm WHERE memberid__c=\''+tt+'\' LIMIT 5')) ((List<Object>)res.get('appointments')).add(new Map<String,Object>{'tipo'=>c.get('activityTitle__c'),'inicio'=>c.get('start_date__c'),'status'=>'Programada'}); }catch(Exception ex){} }
        } catch (Exception e) {} return res;
    }
    private static String cat(String d){ if(d==null)return 'Oftalmicos'; d=d.toLowerCase(); if(d.contains('solar'))return 'Solares'; if(d.contains('contacto'))return 'LentesContacto'; return 'Oftalmicos'; }
}